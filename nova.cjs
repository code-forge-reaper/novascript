#!/usr/bin/env node
import j from"node:path";import{fileURLToPath as ae}from"node:url";import{createRequire as le}from"node:module";import S from"node:fs";import B from"node:path";import R from"node:util";String.prototype.concat=function(...p){let e=String(this);for(let s of p)e+=s+" ";return e};String.prototype.format=function(...p){return R.format(this,...p)};var E=class extends Error{value;constructor(e){super("Return"),this.value=e}},N=class extends Error{constructor(){super("Break")}},C=class extends Error{constructor(){super("Continue")}},l=class extends Error{line;column;file;constructor(e,s){let n=e?.file||"unknown_file",t=e?.line||0,i=e?.column||0,o=e?.value!==void 0?e.value:"N/A",r=`${n}:${t}:${i} ${s||"unknown error at token: "+o}`;super(r),this.line=t,this.column=i,this.file=n}},d=class{values;parent;deferred;constructor(e=null){this.values={},this.parent=e,this.deferred=[]}addDeferred(e){this.deferred.push(e)}executeDeferred(e){for(;this.deferred.length>0;){let s=this.deferred.pop();e.executeStmt(s,this)}}define(e,s){this.values[e]=s}has(e){return e in this.values?!0:this.parent?this.parent.has(e):!1}assign(e,s,n){if(e in this.values)this.values[e]=s;else if(this.parent)this.parent.assign(e,s,n);else throw new l(n,`Undefined variable ${e}`)}get(e,s){if(e in this.values)return this.values[e];if(this.parent)return this.parent.get(e,s);throw s?new l(s,`Undefined variable ${e}`):new Error(`Undefined variable ${e}`)}};function re(p){p.define("print",console.log);let e={major:0,minor:7,patch:5},s={type:"internal",value:"init",file:"internal_init.ts",line:1,column:1};p.define("isArray",Array.isArray),p.define("Logger",{info:(...t)=>console.log("[info %s| at: %i:%i:%i]:",p.get("Runtime",s).versionString,new Date().getHours(),new Date().getMinutes(),new Date().getSeconds(),...t),warn:(...t)=>console.warn("[warn %s| at: %i:%i:%i]:",p.get("Runtime",s).versionString,new Date().getHours(),new Date().getMinutes(),new Date().getSeconds(),...t),error:(...t)=>console.error("[error %s| at: %i:%i:%i]:",p.get("Runtime",s).versionString,new Date().getHours(),new Date().getMinutes(),new Date().getSeconds(),...t)}),p.define("is",{string:t=>typeof t=="string",number:t=>typeof t=="number",boolean:t=>typeof t=="boolean"});let n=process.argv.slice(2);p.define("json",JSON),p.define("parse",{int:parseInt,float:parseFloat,str:String,bool:Boolean}),p.define("math",Math),p.define("null",null),p.define("undefined",void 0),p.define("void",void 0),p.define("NaN",NaN),p.define("Runtime",{dump:{keys:Object.keys,values:Object.values},version:e,versionString:`v${e.major}.${e.minor}.${e.patch}`,currentDirectory:process.cwd,regex:(t,i="")=>new RegExp(t,i),args:n,exit:function(t=0){process.exit(t)},versionAtLeast:function(t,i,o){return e.major>t?!0:e.major<t?!1:e.minor>i?!0:e.minor<i?!1:e.patch>=o},env:t=>t?process.env[t]:process.env,throw:(t,...i)=>{i&&(t=R.format(t,...i));let o={type:"runtime",value:"throw",file:"runtime_internal.ts",line:0,column:0};throw new l(o,t)},fs:{read:function(t){return S.readFileSync(t,"utf8")},write:function(t,i){S.writeFileSync(t,i,"utf8")},exists:function(t){return S.existsSync(t)}},URI:{decode:t=>decodeURIComponent(t),encode:t=>encodeURIComponent(t)},time:{now:()=>Date.now(),str:()=>new Date,hrtime:()=>process.hrtime.bigint().toString()}})}function w(p,e,s,n){let t=p;switch(p==="bool"&&(t="boolean"),t){case"number":if(typeof e!="number")throw new l(s,`Type mismatch: expected number, got ${typeof e}`);break;case"string":if(typeof e!="string")throw new l(s,`Type mismatch: expected string, got ${typeof e}`);break;case"boolean":if(typeof e!="boolean")throw new l(s,`Type mismatch: expected boolean, got ${typeof e}`);break;case"function":if(typeof e!="function")throw new l(s,`Type mismatch: expected function, got ${typeof e}`);break;case"void":if(e!==void 0)throw new l(s,`Type mismatch: expected void, got ${typeof e}`);break;default:let i=n.customTypes.get(p);if(i){if(typeof e!="object"||e===null)throw new l(s,`Type mismatch: expected custom type '${p}', got ${typeof e}`);for(let o of i.properties){if(!(o.name in e))throw new l(s,`Type mismatch: custom type '${p}' is missing property '${o.name}'`);w(o.type,e[o.name],s,n)}}else throw new l(s,`Unknown type: ${p}`)}return e}var b=class{name;superClass;staticMembers;instanceProperties;instanceMethods;staticProperties;constructorDef;interpreter;env;constructor(e,s,n,t){this.name=e,this.superClass=s,this.interpreter=n,this.env=t,this.staticMembers=new Map,this.instanceProperties=new Map,this.instanceMethods=new Map,this.staticProperties=new Map,this.constructorDef=null}_setupInstanceMembersRecursively(e,s){this.superClass&&this.superClass._setupInstanceMembersRecursively(e,s);for(let[n,t]of this.instanceProperties.entries()){let i;t.initializer?i=this.interpreter.evaluateExpr(t.initializer,this.env):i=void 0,Object.defineProperty(e,n,{value:i,writable:!0,enumerable:!0,configurable:!0})}for(let[n,t]of this.instanceMethods.entries())Object.defineProperty(e,n,{value:(...o)=>{let r=new d(this.env);r.define("self",e),this.superClass&&r.define("super",(...a)=>{let c=this.superClass.instanceMethods.get(n);if(!c)throw new l(s,`Method '${n}' not found in superclass '${this.superClass.name}'.`);let u=new d(this.superClass.env);u.define("self",e);for(let f=0;f<c.parameters.length;f++){let h=c.parameters[f],k=a[f];if(k===void 0&&h.default!==void 0)k=this.interpreter.evaluateExpr(h.default,this.superClass.env);else if(k===void 0&&h.default===void 0)throw new l(h,`Missing argument for parameter '${h.name}' in super method '${n}'.`);h.annotationType&&w(h.annotationType,k,h,this.interpreter),u.define(h.name,k)}try{this.interpreter.executeBlock(c.body,u)}catch(f){if(f instanceof E)return f.value;throw f}});for(let a=0;a<t.parameters.length;a++){let c=t.parameters[a],u=o[a];if(u===void 0&&c.default!==void 0)u=this.interpreter.evaluateExpr(c.default,this.env);else if(u===void 0&&c.default===void 0)throw new l(c,`Missing argument for parameter '${c.name}' in method '${t.name}'.`);c.annotationType&&w(c.annotationType,u,c,this.interpreter),r.define(c.name,u)}try{this.interpreter.executeBlock(t.body,r)}catch(a){if(a instanceof E)return a.value;throw a}},writable:!0,enumerable:!0,configurable:!0});return e}_executeConstructorChain(e,s,n){if(!this.constructorDef){this.superClass&&this.superClass._executeConstructorChain(e,s,n);return}let t=new d(this.env);t.define("self",e),this.superClass?t.define("super",(...i)=>{if(!this.superClass)throw new l(n,"Cannot call super() in a class without a superclass.");this.superClass._executeConstructorChain(e,i,n)}):t.define("super",()=>{throw new l(n,"Cannot call super() in a base class constructor.")});for(let i=0;i<this.constructorDef.parameters.length;i++){let o=this.constructorDef.parameters[i],r=s[i];if(r===void 0&&o.default!==void 0)r=this.interpreter.evaluateExpr(o.default,this.env);else if(r===void 0&&o.default===void 0)throw new l(o,`Missing argument for parameter '${o.name}' in constructor of '${this.name}'.`);o.annotationType&&w(o.annotationType,r,o,this.interpreter),t.define(o.name,r)}try{this.interpreter.executeBlock(this.constructorDef.body,t)}catch(i){if(!(i instanceof E))throw i}}instantiate(e,s){let n={};return Object.defineProperty(n,"__novaClass__",{value:this,enumerable:!1,configurable:!0}),this._setupInstanceMembersRecursively(n,s),this._executeConstructorChain(n,e,s),n}},M=class p{keywords=["var","if","else","elseif","end","break","continue","func","return","import","as","namespace","while","forEach","for","do","in","test","failed","defer","switch","case","default","using","def","type","class","inherits","static","new"];source;file;tokens;current;globals;functions;importedFiles;currentEnv=null;customTypes;constructor(e){let s=S.readFileSync(e,"utf8");this.source=s,this.file=e,this.importedFiles=new Set,this.tokens=this.tokenize(s,e),this.current=0,this.globals=new d,this.functions={},this.customTypes=new Map,re(this.globals),this.globals.define("__SCRIPT_PATH__",B.dirname(this.file))}exposeJsClass(e,s){if(typeof s!="function"||!s.prototype||typeof s.prototype.constructor!="function")throw new Error(`Cannot expose '${e}': Provided value is not a valid JavaScript class constructor.`);this.globals.define(e,s)}tokenize(e,s){let n=[],t=0,i=1,o=1,r=e.length;for(;t<r;){let a=e[t],c=o,u=e[t+1];if(/\s/.test(a)){a===`
`?(i++,o=1):o++,t++;continue}if(a==="/"&&u==="/"){for(;t<r&&e[t]!==`
`;)t++;continue}if(a==="/"&&u==="*"){for(t+=2,o+=2;t<r&&!(e[t]==="*"&&t+1<r&&e[t+1]==="/");)e[t]===`
`?(i++,o=1):o++,t++;if(t+1<r&&e[t]==="*"&&e[t+1]==="/")t+=2,o+=2;else throw new l({type:"error",value:"Unterminated comment",file:s,line:i,column:o},"Unterminated multi-line comment");continue}let f=!1,h=["+=","-=","*=","/=","%=","==","!=","<=",">=","&&","||"],k=a+(u||"");if(t+1<r&&h.includes(k)?(n.push({type:"operator",value:k,line:i,column:c,file:s}),t+=2,o+=2,f=!0):"=+-*/%<>!.".includes(a)?(n.push({type:"operator",value:a,line:i,column:c,file:s}),t++,o++,f=!0):"()[]{},:#".includes(a)&&(n.push({type:"operator",value:a,line:i,column:c,file:s}),t++,o++,f=!0),!f){if(/[0-9]/.test(a)){let m="";for(;t<r&&/[0-9\.]/.test(e[t]);)m+=e[t],t++,o++;n.push({type:"number",value:parseFloat(m),line:i,column:c,file:s});continue}if(a==='"'){t++;let m="";for(;t<r&&e[t]!=='"';){if(e[t]==="\\"&&t+1<r)switch(t++,e[t]){case"n":m+=`
`;break;case"t":m+="	";break;case"r":m+="\r";break;case"\\":m+="\\";break;case'"':m+='"';break;default:m+=e[t];break}else m+=e[t];t++,o++,e[t]===`
`&&(o=1,i++)}if(t<r&&e[t]==='"')t++,o++;else throw new l({type:"error",value:"Unterminated string",file:s,line:i,column:o},"Unterminated string literal");n.push({type:"string",value:m,line:i,column:c,file:s});continue}if(/[A-Za-z_]/.test(a)){let m="";for(;t<r&&/[A-Za-z0-9_]/.test(e[t]);)m+=e[t],t++,o++;m==="true"||m==="false"?n.push({type:"boolean",value:m==="true",line:i,column:c,file:s}):this.keywords.includes(m)?n.push({type:"keyword",value:m,line:i,column:c,file:s}):n.push({type:"identifier",value:m,line:i,column:c,file:s});continue}throw new l({type:"error",value:a,file:s,line:i,column:o},`Unexpected character: ${a}`)}}return n}getNextToken(){return this.tokens[this.current]||null}consumeToken(){return this.tokens[this.current++]}expectType(e){let s=this.getNextToken();if(!s||s.type!==e)throw new l(s,`Expected token type ${e}, got ${s?s.type:"EOF"}`);return s}expectToken(e){let s=this.getNextToken();if(!s){let n=this.tokens[this.current-1]||{type:"EOF",value:"EOF",file:this.file,line:1,column:1};throw new l(n,`Expected token '${e}', got EOF`)}if(s.value!==e)throw new l(s,`Expected token '${e}', got ${s.value}`);return s}parseBlockUntil(e=[]){let s=[];for(;this.current<this.tokens.length;){let n=this.getNextToken();if(!n){let i=this.tokens[this.current-1]||{type:"EOF",value:"EOF",file:this.file,line:1,column:1};throw new l(i,"Unexpected end of input")}if(n.type==="keyword"&&e.includes(n.value)||n.type==="operator"&&e.includes(n.value))break;let t=this.parseStatement();t&&s.push(t)}return s}parseBlock(){return this.parseBlockUntil()}consumeExpected(e){return this.expectType(e),this.consumeToken()}parseClassDefinition(){let e=this.consumeToken(),n=this.expectType("identifier").value;this.consumeToken();let t=null;this.getNextToken()?.value==="inherits"&&(this.consumeToken(),t=this.expectType("identifier").value,this.consumeToken());let i=!1,o=[];for(;this.getNextToken()&&this.getNextToken().value!=="end";){let r=this.getNextToken(),a=!1;if(r.type==="keyword"&&r.value==="static"&&(this.consumeToken(),a=!0),this.getNextToken()?.type==="keyword"&&this.getNextToken().value==="var"){this.consumeToken();let c=this.expectType("identifier"),u=c.value;this.consumeToken();let f=null;this.getNextToken()?.type==="operator"&&this.getNextToken().value===":"&&(this.consumeToken(),f=this.expectType("identifier").value,this.consumeToken());let h=null;this.getNextToken()?.type==="operator"&&this.getNextToken().value==="="&&(this.consumeToken(),h=this.parseExpression()),o.push({type:"PropertyDefinition",name:u,typeAnnotation:f,initializer:h,isStatic:a,file:c.file,line:c.line,column:c.column})}else if(this.getNextToken()?.type==="keyword"&&this.getNextToken().value==="func"){this.consumeToken();let c=this.expectType("identifier"),u=c.value;this.consumeToken();let f=!1;u==="init"&&(f=!0,i=!0),this.expectToken("("),this.consumeToken();let h=[];if(this.getNextToken()&&this.getNextToken().value!==")")for(;;){let m=this.expectType("identifier"),A=m.value;this.consumeToken();let P=null;if(this.getNextToken()?.type==="identifier"){let $=this.getNextToken();["string","number","bool","boolean",...this.customTypes.keys()].includes($.value)&&(P=$.value,this.consumeToken())}let D;if(this.getNextToken()?.value==="="&&(this.consumeToken(),D=this.parseExpression()),h.push({name:A,annotationType:P,default:D,file:m.file,line:m.line,column:m.column,type:m.type,value:m.value}),this.getNextToken()?.value===",")this.consumeToken();else break}this.expectToken(")"),this.consumeToken();let k=this.parseBlockUntil(["end"]);this.expectToken("end"),this.consumeToken(),o.push({type:"MethodDefinition",name:u,parameters:h,body:k,isStatic:a,isConstructor:f,file:c.file,line:c.line,column:c.column})}else throw new l(r,`Unexpected token in class body: ${r.value}`)}if(!i)throw new l(e,"this class has no `init` initializer function");return this.expectToken("end"),this.consumeToken(),{type:"ClassDefinition",name:n,superclassName:t,body:o,file:e.file,line:e.line,column:e.column}}parseStatement(){let e=this.getNextToken();if(!e){let n=this.tokens[this.current-1]||{type:"EOF",value:"EOF",file:this.file,line:1,column:1};throw new l(n,"Unexpected end of input")}if(e.type==="keyword")switch(e.value){case"defer":this.consumeToken();let n=this.parseBlockUntil(["end"]);return this.expectToken("end"),this.consumeToken(),{type:"DeferStmt",body:n,line:e.line,column:e.column,file:e.file};case"type":this.consumeToken();let i=this.expectType("identifier").value;this.consumeToken(),this.expectToken("="),this.consumeToken(),this.expectToken("{"),this.consumeToken();let o=[];for(;this.getNextToken()&&this.getNextToken().value!=="}";){let v=this.expectType("identifier").value;this.consumeToken(),this.expectToken(":"),this.consumeToken();let g=this.expectType("identifier").value;if(this.consumeToken(),o.push({name:v,type:g}),this.getNextToken()&&this.getNextToken().value===",")this.consumeToken();else break}this.expectToken("}"),this.consumeToken();let r={type:"CustomTypeDecl",name:i,definition:o,file:e.file,line:e.line,column:e.column};this.customTypes.set(r.name,{name:r.name,properties:r.definition,file:r.file,line:r.line,column:r.column});return;case"var":this.consumeToken();let c=this.expectType("identifier").value;this.consumeToken();let u=null;this.getNextToken()&&this.getNextToken().type==="identifier"&&["string","number","boolean","void","bool",...this.customTypes.keys()].includes(this.getNextToken().value)&&(u=this.getNextToken().value,this.consumeToken()),this.expectToken("="),this.consumeToken();let f=this.parseExpression();return{type:"VarDecl",name:c,typeAnnotation:u,initializer:f,line:e.line,column:e.column,file:e.file};case"switch":this.consumeToken();let h=this.parseExpression(),k=[];for(;this.getNextToken()?.type==="keyword"&&this.getNextToken().value==="case";){this.consumeToken();let y=this.parseExpression();this.expectToken("do"),this.consumeToken();let v=this.parseBlockUntil(["end"]);this.expectToken("end"),this.consumeToken(),k.push({caseExpr:y,body:v})}if(this.getNextToken()?.type==="keyword"&&this.getNextToken().value==="default"){this.consumeToken(),this.expectToken("do"),this.consumeToken();let y=this.parseBlockUntil(["end"]);this.expectToken("end"),this.consumeToken(),k.push({caseExpr:null,body:y})}return this.expectToken("end"),this.consumeToken(),{type:"SwitchStmt",expression:h,cases:k,line:e.line,column:e.column,file:e.file};case"using":this.consumeToken();let m=this.expectType("identifier");return this.consumeToken(),{type:"UsingStmt",name:m.value,line:e.line,column:e.column,file:e.file};case"test":this.consumeToken();let A=this.parseBlockUntil(["failed"]);this.expectToken("failed"),this.consumeToken();let D=this.expectType("identifier").value;this.consumeToken();let $=this.parseBlockUntil(["end"]);return this.expectToken("end"),this.consumeToken(),{type:"TryStmt",tryBlock:A,errorVar:D,catchBlock:$,line:e.line,column:e.column,file:e.file};case"forEach":this.consumeToken();let z=this.expectType("identifier").value;this.consumeToken(),this.expectToken("in"),this.consumeToken();let G=this.parseExpression();this.expectToken("do"),this.consumeToken();let K=this.parseBlockUntil(["end"]);return this.expectToken("end"),this.consumeToken(),{type:"ForEachStmt",variable:z,list:G,body:K,line:e.line,column:e.column,file:e.file};case"for":this.consumeToken();let q=this.expectType("identifier").value;this.consumeToken(),this.expectToken("="),this.consumeToken();let H=this.parseExpression();this.expectToken(","),this.consumeToken();let J=this.parseExpression(),I;this.getNextToken()?.value===","&&(this.consumeToken(),I=this.parseExpression()),this.expectToken("do"),this.consumeToken();let W=this.parseBlockUntil(["end"]);return this.expectToken("end"),this.consumeToken(),{type:"ForStmt",variable:q,start:H,end:J,step:I,body:W,line:e.line,column:e.column,file:e.file};case"while":this.consumeToken();let Z=this.parseExpression(),Q=this.parseBlockUntil(["end"]);return this.expectToken("end"),this.consumeToken(),{type:"WhileStmt",condition:Z,body:Q,line:e.line,column:e.column,file:e.file};case"break":return this.consumeToken(),{type:"BreakStmt",line:e.line,column:e.column,file:e.file};case"continue":return this.consumeToken(),{type:"ContinueStmt",line:e.line,column:e.column,file:e.file};case"if":this.consumeToken();let X=this.parseExpression(),Y=this.parseBlockUntil(["else","elseif","end"]),U=[],F=null;for(;this.getNextToken()?.type==="keyword"&&this.getNextToken().value==="elseif";){this.consumeToken();let y=this.parseExpression(),v=this.parseBlockUntil(["else","elseif","end"]);U.push({condition:y,body:v})}return this.getNextToken()?.type==="keyword"&&this.getNextToken().value==="else"&&(this.consumeToken(),F=this.parseBlockUntil(["end"])),this.expectToken("end"),this.consumeToken(),{type:"IfStmt",condition:X,thenBlock:Y,elseBlock:F,elseIf:U.length>0?U:null,line:e.line,column:e.column,file:e.file};case"namespace":this.consumeToken();let ee=this.expectType("identifier").value;this.consumeToken();let te=this.parseBlockUntil(["end"]);return this.expectToken("end"),this.consumeToken(),{type:"NamespaceStmt",name:ee,body:te,line:e.line,column:e.column,file:e.file};case"func":this.consumeToken();let ne=this.expectType("identifier").value;this.consumeToken(),this.expectToken("("),this.consumeToken();let L=[];if(this.getNextToken()&&this.getNextToken().value!==")")for(;;){let y=this.expectType("identifier"),v=y.value;this.consumeToken();let T=null;if(this.getNextToken()?.type==="identifier"){let x=this.getNextToken();["string","number","bool","boolean",...this.customTypes.keys()].includes(x.value)&&(T=x.value,this.consumeToken())}let g;if(this.getNextToken()?.value==="="){if(this.consumeToken(),g=this.parseExpression(),T)throw new l(e,"Cannot have both explicit type annotation and a default value. Consider removing the type annotation to allow type inference from the default value.");if(g.type==="Literal"){let x=typeof g.value;x==="string"?T="string":x==="number"?T="number":x==="boolean"?T="bool":T=null}else T=null}if(L.push({name:v,annotationType:T,default:g,file:y.file,line:y.line,column:y.column,type:y.type,value:y.value}),this.getNextToken()?.value===",")this.consumeToken();else break}this.expectToken(")"),this.consumeToken();let se=this.parseBlockUntil(["end"]);return this.expectToken("end"),this.consumeToken(),{type:"FuncDecl",name:ne,parameters:L,body:se,file:e.file,line:e.line,column:e.column};case"def":this.consumeToken(),this.expectToken("("),this.consumeToken();let O=[];if(this.getNextToken()&&this.getNextToken().value!==")")for(;;){let y=this.expectType("identifier"),v=y.value;this.consumeToken();let T=null;if(this.getNextToken()?.type==="identifier"){let x=this.getNextToken();["string","number","bool","boolean",...this.customTypes.keys()].includes(x.value)&&(T=x.value,this.consumeToken())}let g;if(this.getNextToken()?.value==="="){if(this.consumeToken(),g=this.parseExpression(),T)throw new l(e,"Cannot have both explicit type annotation and a default value. Consider removing the type annotation to allow type inference from the default value.");if(g.type==="Literal"){let x=typeof g.value;x==="string"?T="string":x==="number"?T="number":x==="boolean"?T="bool":T=null}else T=null}if(O.push({name:v,annotationType:T,default:g,file:y.file,line:y.line,column:y.column,type:y.type,value:y.value}),this.getNextToken()?.value===",")this.consumeToken();else break}this.expectToken(")"),this.consumeToken();let ie=this.parseBlockUntil(["end"]);return this.expectToken("end"),this.consumeToken(),{type:"LambdaDecl",parameters:O,body:ie,file:e.file,line:e.line,column:e.column};case"return":this.consumeToken();let V=null;return this.getNextToken()&&!this.keywords.includes(this.getNextToken().value)&&(V=this.parseExpression()),{type:"ReturnStmt",expression:V,file:e.file,line:e.line,column:e.column};case"import":this.consumeToken();let oe=this.expectType("string").value;this.consumeToken();let _=null;return this.getNextToken()&&this.getNextToken().value==="as"&&(this.consumeToken(),_=this.expectType("identifier").value,this.consumeToken()),{type:"ImportStmt",filename:oe,alias:_,file:e.file,line:e.line,column:e.column};case"class":return this.parseClassDefinition()}return{type:"ExpressionStmt",expression:this.parseExpression(),file:e.file,line:e.line,column:e.column}}parseExpression(){return this.parseAssignment()}parseAssignment(){let e=this.parseLogicalOr(),s=this.getNextToken();if(s&&s.type==="operator"&&["=","+=","-=","*=","/=","%="].includes(s.value)){let n=this.consumeToken(),t=this.parseAssignment();if(e.type!=="Identifier"&&e.type!=="PropertyAccess"&&e.type!=="ArrayAccess"&&e.type!=="ArrayLiteral")throw new l(e,`Invalid assignment target: Cannot assign to ${e.type}`);return{type:"AssignmentExpr",target:e,value:t,operator:n.value,file:n.file,line:n.line,column:n.column}}return e}parseLogicalOr(){let e=this.parseLogicalAnd();for(;this.getNextToken()&&this.getNextToken().type==="operator"&&this.getNextToken().value==="||";){let s=this.consumeToken(),n=s.value,t=this.parseLogicalAnd();e={type:"BinaryExpr",operator:n,left:e,right:t,file:s.file,line:s.line,column:s.column}}return e}parseLogicalAnd(){let e=this.parseEquality();for(;this.getNextToken()&&this.getNextToken().type==="operator"&&this.getNextToken().value==="&&";){let s=this.consumeToken(),n=s.value,t=this.parseEquality();e={type:"BinaryExpr",operator:n,left:e,right:t,file:s.file,line:s.line,column:s.column}}return e}parseEquality(){let e=this.parseComparison();for(;this.getNextToken()&&this.getNextToken().type==="operator"&&(this.getNextToken().value==="=="||this.getNextToken().value==="!=");){let s=this.consumeToken(),n=s.value,t=this.parseComparison();e={type:"BinaryExpr",operator:n,left:e,right:t,file:s.file,line:s.line,column:s.column}}return e}parseComparison(){let e=this.parseTerm();for(;this.getNextToken()&&this.getNextToken().type==="operator"&&["<","<=",">",">="].includes(this.getNextToken().value);){let s=this.consumeToken(),n=s.value,t=this.parseTerm();e={type:"BinaryExpr",operator:n,left:e,right:t,file:s.file,line:s.line,column:s.column}}return e}parseTerm(){let e=this.parseFactor();for(;this.getNextToken()&&this.getNextToken().type==="operator"&&(this.getNextToken().value==="+"||this.getNextToken().value==="-");){let s=this.consumeToken(),n=s.value,t=this.parseFactor();e={type:"BinaryExpr",operator:n,left:e,right:t,file:s.file,line:s.line,column:s.column}}return e}parseFactor(){let e=this.parseUnary();for(;this.getNextToken()&&this.getNextToken().type==="operator"&&(this.getNextToken().value==="*"||this.getNextToken().value==="/"||this.getNextToken().value==="%");){let s=this.consumeToken(),n=s.value,t=this.parseUnary();e={type:"BinaryExpr",operator:n,left:e,right:t,file:s.file,line:s.line,column:s.column}}return e}parseUnary(){if(this.getNextToken()&&this.getNextToken().type==="operator"&&(this.getNextToken().value==="-"||this.getNextToken().value==="!")){let e=this.consumeToken(),s=e.value,n=this.parseUnary();return{type:"UnaryExpr",operator:s,right:n,file:e.file,line:e.line,column:e.column}}return this.parseCallMemberExpression()}parseCallMemberExpression(){let e=this.parsePrimary();for(;;){let s=this.getNextToken();if(!s)break;if(s.value==="."){let n=this.consumeToken(),t=this.expectType("identifier"),i=t.value;if(this.consumeToken(),this.getNextToken()&&this.getNextToken().value==="("){this.consumeToken();let o=[];if(this.getNextToken()&&this.getNextToken().value!==")")for(;o.push(this.parseExpression()),this.getNextToken()&&this.getNextToken().value===",";)this.consumeToken();this.expectToken(")"),this.consumeToken(),e={type:"MethodCall",object:e,method:i,arguments:o,file:t.file,line:t.line,column:t.column}}else e={type:"PropertyAccess",object:e,property:i,file:t.file,line:t.line,column:t.column}}else if(s.value==="["){let n=this.consumeToken(),t=this.parseExpression();this.expectToken("]"),this.consumeToken(),e={type:"ArrayAccess",object:e,index:t,file:n.file,line:n.line,column:n.column}}else if(s.value==="("&&e.type==="Identifier"){this.consumeToken();let n=[];if(this.getNextToken()&&this.getNextToken().value!==")")for(;n.push(this.parseExpression()),this.getNextToken()&&this.getNextToken().value===",";)this.consumeToken();this.expectToken(")"),this.consumeToken(),e={type:"FuncCall",name:e.name,arguments:n,file:e.file,line:e.line,column:e.column}}else break}return e}parsePrimary(){let e,s=this.getNextToken();if(!s){let n=this.tokens[this.current-1]||{type:"EOF",value:"EOF",file:this.file,line:1,column:1};throw new l(n,"Unexpected end of input")}if(s.type==="boolean")this.consumeToken(),e={type:"Literal",value:s.value,file:s.file,line:s.line,column:s.column};else if(s.type==="number"||s.type==="string")this.consumeToken(),e={type:"Literal",value:s.value,file:s.file,line:s.line,column:s.column};else if(s.value==="["){this.consumeToken();let n=[];if(this.getNextToken()&&this.getNextToken().value!=="]")for(;n.push(this.parseExpression()),this.getNextToken()&&this.getNextToken().value===",";)this.consumeToken();this.expectToken("]"),this.consumeToken(),e={type:"ArrayLiteral",elements:n,file:s.file,line:s.line,column:s.column}}else if(s.value==="{"){this.consumeToken();let n=[];if(this.getNextToken()&&this.getNextToken().value!=="}")for(;;){let t=this.getNextToken();if(t.type!=="identifier"&&t.type!=="string")throw new l(t,"Expected identifier or string as object key");let i=t.value;this.consumeToken(),this.expectToken(":"),this.consumeToken();let o=this.parseExpression();if(n.push({key:i,value:o}),this.getNextToken()&&this.getNextToken().value===",")this.consumeToken();else break}this.expectToken("}"),this.consumeToken(),e={type:"ObjectLiteral",properties:n,file:s.file,line:s.line,column:s.column}}else if(s.type==="identifier")this.consumeToken(),e={type:"Identifier",name:s.value,file:s.file,line:s.line,column:s.column};else if(s.type==="keyword"&&s.value==="new"){this.consumeToken();let n=this.expectType("identifier"),t=n.value;this.consumeToken(),this.expectToken("("),this.consumeToken();let i=[];if(this.getNextToken()&&this.getNextToken().value!==")")for(;i.push(this.parseExpression()),this.getNextToken()&&this.getNextToken().value===",";)this.consumeToken();this.expectToken(")"),this.consumeToken(),e={type:"NewInstance",className:t,arguments:i,file:n.file,line:n.line,column:n.column}}else if(s.value=="def"){this.consumeToken(),this.expectToken("("),this.consumeToken();let n=[];if(this.getNextToken()&&this.getNextToken().value!==")")for(;;){let i=this.expectType("identifier"),o=i.value;this.consumeToken();let r=null;if(this.getNextToken()?.type==="identifier"){let c=this.getNextToken();["string","number","bool","boolean"].includes(c.value)&&(r=c.value,this.consumeToken())}let a;if(this.getNextToken()?.value==="="){if(this.consumeToken(),a=this.parseExpression(),r)throw new l(s,"Cannot have both explicit type annotation and a default value. Consider removing the type annotation to allow type inference from the default value.");if(a.type==="Literal"){let c=typeof a.value;c==="string"?r="string":c==="number"?r="number":c==="boolean"?r="bool":r=null}else r=null}if(n.push({name:o,annotationType:r,default:a,file:i.file,line:i.line,column:i.column,type:i.type,value:i.value}),this.getNextToken()?.value===",")this.consumeToken();else break}this.expectToken(")"),this.consumeToken();let t=this.parseBlockUntil(["end"]);return this.expectToken("end"),this.consumeToken(),{type:"LambdaDecl",parameters:n,body:t,file:s.file,line:s.line,column:s.column}}else if(s.value==="(")this.consumeToken(),e=this.parseExpression(),this.expectToken(")"),this.consumeToken();else throw new l(s,`Unexpected token: ${s.value}`);return e}interpret(){let e=this.parseBlock();try{this.executeBlock(e,this.globals)}catch(s){throw this.globals.executeDeferred(this),s}}executeBlock(e,s){let n=this.currentEnv;this.currentEnv=s;try{for(let t of e)this.executeStmt(t,s)}finally{s.executeDeferred(this),this.currentEnv=n}this.currentEnv=n}getCurrentContext(){return this.currentEnv}executeStmt(e,s){switch(e.type){case"VarDecl":{let n=e,t=this.evaluateExpr(n.initializer,s);n.typeAnnotation&&w(n.typeAnnotation,t,n,this),s.define(n.name,t);break}case"DeferStmt":{let n=[];e.body.forEach(t=>n.push(t)),n.reverse().forEach(t=>s.addDeferred(t));break}case"ExpressionStmt":{this.evaluateExpr(e.expression,s);break}case"BreakStmt":throw new N;case"ContinueStmt":throw new C;case"TryStmt":{try{this.executeBlock(e.tryBlock,s)}catch(n){let t=new d(s),i=n instanceof Error||n instanceof l?n:new l(e,String(n));t.define(e.errorVar,i),this.executeBlock(e.catchBlock,t)}break}case"IfStmt":{if(this.evaluateExpr(e.condition,s))this.executeBlock(e.thenBlock,new d(s));else if(e.elseIf){let t=!1,i=new d(s);for(let o of e.elseIf)if(this.evaluateExpr(o.condition,i)){this.executeBlock(o.body,i),t=!0;break}!t&&e.elseBlock&&this.executeBlock(e.elseBlock,new d(s))}else e.elseBlock&&this.executeBlock(e.elseBlock,new d(s));break}case"WhileStmt":{for(;this.evaluateExpr(e.condition,s);)try{this.executeBlock(e.body,new d(s))}catch(n){if(n instanceof N)break;if(n instanceof C)continue;throw n}break}case"ForEachStmt":{let n=this.evaluateExpr(e.list,s);if(!Array.isArray(n))throw new l(e,`Cannot iterate over non-array type for forEach loop. Got: ${typeof n}`);for(let t of n){let i=new d(s);i.define(e.variable,t);try{this.executeBlock(e.body,i)}catch(o){if(o instanceof N)break;if(o instanceof C)continue;throw o}}break}case"ForStmt":{let n=this.evaluateExpr(e.start,s),t=this.evaluateExpr(e.end,s),i=e.step?this.evaluateExpr(e.step,s):1;if(typeof n!="number"||typeof t!="number"||typeof i!="number")throw new l(e,`For loop bounds and step must be numbers. Got start: ${typeof n}, end: ${typeof t}, step: ${typeof i}`);for(let o=n;o<=t;o+=i){let r=new d(s);r.define(e.variable,o);try{this.executeBlock(e.body,r)}catch(a){if(a instanceof N)break;if(a instanceof C)continue;throw a}}break}case"ImportStmt":{let n=e.filename;if(e.filename.startsWith("os:")){if(n=n.substring(3),!s.has("os-import-handler"))throw new l(e,"os-import-handler is not defined, your runtime should define it, interpreter.globals.define('os-import-handler', handler)");let k=s.get("os-import-handler",e)(n),m=e.alias||n;s.define(m,k);break}n+=".nova";let t=B.dirname(this.file),i=B.resolve(t,n);if(this.importedFiles.has(i))break;if(this.importedFiles.add(i),!S.existsSync(i))throw new l(e,`Import error: File not found at '${i}'`);let o=new p(i);o.customTypes=this.customTypes;let r=new d(this.globals);o.globals=r,o.functions=this.functions,o.importedFiles=this.importedFiles,o.interpret();let a={};for(let h in r.values)a[h]=r.values[h];let u=B.parse(n).name,f=e.alias||u;s.define(f,a);break}case"NamespaceStmt":{let n=new d(s);this.executeBlock(e.body,n),s.define(e.name,n);break}case"SwitchStmt":{let n=this.evaluateExpr(e.expression,s),t=!1,i=null;for(let o of e.cases)if(o.caseExpr===null)i=o.body;else{let r=this.evaluateExpr(o.caseExpr,s);if(n===r){this.executeBlock(o.body,new d(s)),t=!0;break}}!t&&i&&this.executeBlock(i,new d(s));break}case"ReturnStmt":{let n=e.expression?this.evaluateExpr(e.expression,s):void 0;throw new E(n)}case"FuncDecl":{let n=(...t)=>{let i=new d(s);for(let o=0;o<e.parameters.length;o++){let r=e.parameters[o],a=t[o];if(a===void 0&&r.default!==void 0)a=this.evaluateExpr(r.default,s);else if(a===void 0&&r.default===void 0)throw new l(r,`Missing argument for parameter '${r.name}' in function '${e.name}'.`);r.annotationType&&w(r.annotationType,a,r,this),i.define(r.name,a)}try{this.executeBlock(e.body,i)}catch(o){if(o instanceof E)return o.value;throw o}};s.define(e.name,n);break}case"ClassDefinition":{let n=e,t=new b(n.name,null,this,s);for(let i of n.body)if(i.type==="PropertyDefinition")if(i.isStatic){t.staticProperties.set(i.name,i);let o;i.initializer?o=this.evaluateExpr(i.initializer,s):o=void 0,i.typeAnnotation&&w(i.typeAnnotation,o,i,this),t.staticMembers.set(i.name,o)}else t.instanceProperties.set(i.name,i);else if(i.type==="MethodDefinition")if(i.isConstructor)t.constructorDef=i;else if(i.isStatic){let o=(...r)=>{let a=new d(s);a.define("self",t.staticMembers);for(let c=0;c<i.parameters.length;c++){let u=i.parameters[c],f=r[c];if(f===void 0&&u.default!==void 0)f=this.evaluateExpr(u.default,s);else if(f===void 0&&u.default===void 0)throw new l(u,`Missing argument for parameter '${u.name}' in static method '${i.name}'.`);u.annotationType&&w(u.annotationType,f,u,this),a.define(u.name,f)}try{this.executeBlock(i.body,a)}catch(c){if(c instanceof E)return c.value;throw c}};t.staticMembers.set(i.name,o)}else t.instanceMethods.set(i.name,i);if(n.superclassName){let i=s.get(n.superclassName,n);if(!i||!(i instanceof b))throw new l(n,`Superclass '${n.superclassName}' not found or is not a class.`);t.superClass=i}s.define(n.name,t);break}case"UsingStmt":{let n=s.get(e.name,e);if(n instanceof d)for(let[t,i]of Object.entries(n.values))s.define(t,i);else if(typeof n=="object"&&n!==null)for(let[t,i]of Object.entries(n))s.define(t,i);else throw new l(e,`Cannot 'use' non-namespace value '${e.name}'.`);break}default:throw new l(e,`Unknown statement type: ${e.type}`)}}resolveAssignmentTarget(e,s){if(e.type==="Identifier")return{base:s,finalKey:e.name};if(e.type==="ArrayAccess"){let n=e,t=this.evaluateExpr(n.object,s),i=this.evaluateExpr(n.index,s);if(t==null)throw new l(n,"Cannot assign to index of null or undefined value.");if(!Array.isArray(t)&&typeof t!="object")throw new l(n,`Cannot assign to index of non-array/object: ${typeof t}`);if(typeof i!="number"&&typeof i!="string")throw new l(n,`Array/object index must be a number or string for assignment. Got: ${typeof i}`);return{base:t,finalKey:i}}else if(e.type==="PropertyAccess"){let n=e,t=this.evaluateExpr(n.object,s),i=n.property;if(t==null)throw new l(n,`Cannot assign property '${i}' of null or undefined value.`);return t instanceof d?{base:t,finalKey:i}:{base:t,finalKey:i}}else throw new l(e,"Invalid assignment target type: "+e.type)}evaluateExpr(e,s){switch(e.type){case"Literal":return e.value;case"Identifier":return s.get(e.name,e);case"AssignmentExpr":{let n=e,t=n.target,i=this.evaluateExpr(n.value,s),o=n.operator,r=i;if(o!=="="){if(t.type==="ArrayLiteral")throw new l(t,`Compound assignment operators like '${o}' cannot be used with array destructuring.`);let a=this.evaluateExpr(t,s);switch(o){case"+=":r=a+i;break;case"-=":r=a-i;break;case"*=":r=a*i;break;case"/=":if(i===0)throw new l(e,"Division by zero in compound assignment.");r=a/i;break;case"%=":r=a%i;break;default:throw new l(e,`Internal error: Unknown compound assignment operator: ${o}`)}}if(t.type==="ArrayLiteral"){let a=r;if(!Array.isArray(a))throw new l(t,`Cannot destructure non-array value. Expected array, got ${typeof a}.`);let c=t;for(let u=0;u<c.elements.length;u++){let f=c.elements[u],h=a[u],k={type:"AssignmentExpr",target:f,value:{type:"Literal",value:h,file:e.file,line:e.line,column:e.column},operator:"=",file:e.file,line:e.line,column:e.column};this.evaluateExpr(k,s)}}else{let{base:a,finalKey:c}=this.resolveAssignmentTarget(t,s);if(t.type==="PropertyAccess"){let u=t,f=this.evaluateExpr(u.object,s),h;f instanceof b?h=f.staticProperties.get(u.property):f&&typeof f=="object"&&f.__novaClass__ instanceof b&&(h=f.__novaClass__.instanceProperties.get(u.property)),h&&h.typeAnnotation&&w(h.typeAnnotation,r,n,this)}if(a instanceof d)a.assign(c,r,t);else if(c!==null)a[c]=r;else throw new l(t,"Failed to resolve assignment target.")}return r}case"BinaryExpr":{let n=this.evaluateExpr(e.left,s),t=this.evaluateExpr(e.right,s);if((typeof n!="number"||typeof t!="number")&&!(e.operator!=="=="||e.operator!=="!="))throw new l(e,`Cannot perform binary operation on non-number types: ${typeof n} and ${typeof t}`);switch(e.operator){case"+":return n+t;case"%":return n%t;case"-":return n-t;case"*":return n*t;case"/":if(t===0)throw new l(e,"Division by zero is not allowed.");return n/t;case"==":return n===t;case"!=":return n!==t;case"<":return n<t;case"<=":return n<=t;case">":return n>t;case">=":return n>=t;case"&&":return n&&t;case"||":return n||t;default:throw new l(e,`Unknown binary operator: ${e.operator}`)}}case"UnaryExpr":{let n=this.evaluateExpr(e.right,s);switch(e.operator){case"-":if(typeof n!="number")throw new l(e,`Unary '-' operator can only be applied to numbers. Got: ${typeof n}`);return-n;case"!":return!n;default:throw new l(e,`Unknown unary operator: ${e.operator}`)}}case"FuncCall":{let n=s.get(e.name,e);if(typeof n!="function")throw new l(e,`${e.name} is not a function`);let t=e.arguments.map(i=>this.evaluateExpr(i,s));return n(...t)}case"MethodCall":{let n=e,t=this.evaluateExpr(n.object,s);if(t==null)throw new l(n,`Cannot call method '${n.method}' on null or undefined.`);let i=n.arguments.map(r=>this.evaluateExpr(r,s));if(t instanceof b){let r=t.staticMembers.get(n.method);if(typeof r=="function")return r.apply(t.staticMembers,i);throw new l(n,`Static method '${n.method}' not found or is not a function on class '${t.name}'.`)}let o;if(t instanceof d?o=t.get(n.method,n):o=t[n.method],typeof o!="function")throw new l(n,`${n.method} is not a function or method on this object`);return o.apply(t,i)}case"ArrayAccess":{let n=this.evaluateExpr(e.object,s),t=this.evaluateExpr(e.index,s);if(!Array.isArray(n)&&typeof n!="object")throw new l(e,`Cannot access index of non-array/object: ${typeof n}`);if(typeof t!="number"&&typeof t!="string")throw new l(e,`Array/object index must be a number or string. Got: ${typeof t}`);return n[t]}case"PropertyAccess":{let n=e,t=this.evaluateExpr(n.object,s);if(t==null)throw new l(n,`Cannot access property '${n.property}' of null or undefined.`);if(t instanceof b){if(t.staticMembers.has(n.property))return t.staticMembers.get(n.property);throw new l(n,`Static property '${n.property}' not found on class '${t.name}'.`)}if(t instanceof d)return t.get(n.property,n);if((typeof t=="object"||typeof t=="function")&&n.property in t)return t[n.property];throw new l(n,`Property '${n.property}' not found on object.`)}case"ArrayLiteral":return e.elements.map(n=>this.evaluateExpr(n,s));case"ObjectLiteral":{let n={};for(let t of e.properties)n[t.key]=this.evaluateExpr(t.value,s);return n}case"NewInstance":{let n=e,t=n.className,i=s.get(t,n),o=n.arguments.map(r=>this.evaluateExpr(r,s));if(i instanceof b)return i.instantiate(o,n);if(typeof i=="function"&&i.prototype&&typeof i.prototype.constructor=="function")try{return Reflect.construct(i,o)}catch(r){throw new l(n,`Error instantiating JavaScript class '${t}': ${r.message}`)}else throw new l(n,`'${t}' is not a constructible class.`)}case"LambdaDecl":{let n=e;return(...i)=>{let o=new d(s);for(let r=0;r<n.parameters.length;r++){let a=n.parameters[r],c=i[r];if(c===void 0&&a.default!==void 0)c=this.evaluateExpr(a.default,s);else if(c===void 0&&a.default===void 0)throw new l(a,`Missing argument for parameter '${a.name}'.`);a.annotationType&&w(a.annotationType,c,a,this),o.define(a.name,c)}try{this.executeBlock(n.body,o)}catch(r){if(r instanceof E)return r.value;throw r}}}default:throw new l(e,`Unknown expression type: ${e.type}`)}}};var ce=j.resolve(process.argv[2]||"main.nova"),ue=ae(import.meta.url),Ne=j.dirname(ue),pe=le(j.join(process.cwd(),"noop.js"));try{let p=new M(ce);p.globals.define("os-import-handler",e=>{try{return pe(e)}catch(s){return console.error(s),null}}),p.interpret()}catch(p){console.log(p.message)}
